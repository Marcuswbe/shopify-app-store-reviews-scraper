import asyncio, csv, subprocess, tempfile
from apify import Actor

async def main():
    async with Actor:
        inp   = await Actor.get_input() or {}
        url   = inp.get("app_url")
        limit = str(inp.get("limit", 100000))      # big default

        if not url:
            raise ValueError("Input must contain 'app_url'")

        tmp = tempfile.NamedTemporaryFile(delete=False,
                                          suffix=".csv").name

  subprocess.run(
    [
        "scrapy", "crawl", "reviews",
        "-a", f"url={url}",
        "-a", f"limit={limit}",
        "-s", "CLOSESPIDER_ITEMCOUNT=0",   # already there
        "-s", "CLOSESPIDER_PAGECOUNT=0",   # ‚Üê NEW: no page cap
        "-O", tmp,
    ],
    check=True,
)

        with open(tmp, newline="", encoding="utf-8") as f:
            for row in csv.DictReader(f):
                await Actor.push_data(row)

if __name__ == "__main__":
    asyncio.run(main())
