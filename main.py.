import asyncio, csv, subprocess, tempfile
from apify import Actor

async def main():
    async with Actor:
        inp = await Actor.get_input() or {}

        url = inp.get("app_url")
        if not url:
            raise ValueError("Input must contain 'app_url'")

        # NEW — read limit from input; default 0 means "no cap"
        limit = str(inp.get("limit", 10000))   # 0 = spider scrapes all pages

        tmp = tempfile.NamedTemporaryFile(delete=False, suffix=".csv").name

        # NEW — include the limit argument when we call Scrapy
        subprocess.run(
            [
                "scrapy",
                "crawl",
                "reviews",
                "-a", f"url={url}",
                "-a", f"limit={limit}",
                "-O", tmp,
            ],
            check=True,
        )

        with open(tmp, newline="", encoding="utf-8") as f:
            for row in csv.DictReader(f):
                await Actor.push_data(row)

if __name__ == "__main__":
    asyncio.run(main())
